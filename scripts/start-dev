#!/bin/bash

# Parse arguments
NGROK_DOMAIN=""
while [[ $# -gt 0 ]]; do
  case $1 in
    --domain)
      NGROK_DOMAIN="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: start-dev [--domain <ngrok-domain>]"
      exit 1
      ;;
  esac
done

# Detect worktree and calculate port
CURRENT_DIR=$(pwd)
DIR_NAME=$(basename "$CURRENT_DIR")

# Convert worktree suffix to slot number
# Supports both numeric (wt1, wt2) and alpha (wta, wtb)
# a=1, b=2, ..., z=26
worktree_suffix_to_slot() {
  local suffix="$1"
  if [[ "$suffix" =~ ^[0-9]+$ ]]; then
    echo "$suffix"
  elif [[ "$suffix" =~ ^[a-z]$ ]]; then
    # Convert a-z to 1-26
    printf '%d' "$(($(printf '%d' "'$suffix") - 96))"
  else
    echo ""
  fi
}

# Determine slot based on directory name
# platform -> slot 0, platform-wt1 -> slot 1, platform-wta -> slot 1, etc.
if [[ "$DIR_NAME" == "platform" ]]; then
  SLOT=0
elif [[ "$DIR_NAME" =~ ^platform-wt([0-9]+)$ ]]; then
  SLOT=${BASH_REMATCH[1]}
elif [[ "$DIR_NAME" =~ ^platform-wt([a-z])$ ]]; then
  SLOT=$(worktree_suffix_to_slot "${BASH_REMATCH[1]}")
else
  echo "Error: Must be run from platform or platform-wt* directory"
  echo "Current directory: $CURRENT_DIR"
  exit 1
fi

# Calculate ports based on slot (all ports end with slot number for clarity)
PORT=$((3000 + SLOT))
INNGEST_PORT=$((9000 + SLOT))
INNGEST_CONNECT_GATEWAY_PORT=$((8290 + SLOT))
INNGEST_CONNECT_GATEWAY_GRPC_PORT=$((50050 + SLOT))
INNGEST_CONNECT_EXECUTOR_GRPC_PORT=$((50060 + SLOT))

if [[ -n "$NGROK_DOMAIN" ]]; then
  echo "Starting opine-dev for $DIR_NAME with ngrok (domain: $NGROK_DOMAIN, inngest: $INNGEST_PORT)"
else
  echo "Starting opine-dev for $DIR_NAME (server: $PORT, inngest: $INNGEST_PORT)"
fi

# Kill all other panes, start fresh
tmux kill-pane -a

# Start server in current pane
if [[ -n "$NGROK_DOMAIN" ]]; then
  tmux send-keys "nx run platform:serve:ngrok --exclude-task-dependencies --domain $NGROK_DOMAIN" C-m
else
  tmux send-keys "nx run platform:serve:turbo --exclude-task-dependencies" C-m
fi

# Create right pane (35%) for inngest
tmux split-window -h -l 35% -c "$CURRENT_DIR"
sleep 0.3  # Let shell initialize (fzf, etc.)

# Start inngest in right pane
if [[ $SLOT -eq 0 ]]; then
  # Root platform directory: use default inngest ports
  tmux send-keys "npx inngest-cli@latest dev --no-discovery --poll-interval 120 -u https://localhost:$PORT/api/v1/inngest" C-m
else
  # Worktree: use custom ports to avoid conflicts
  tmux send-keys "npx inngest-cli@latest dev --no-discovery --poll-interval 120 --port $INNGEST_PORT --connect-gateway-port $INNGEST_CONNECT_GATEWAY_PORT --connect-gateway-grpc-port $INNGEST_CONNECT_GATEWAY_GRPC_PORT --connect-executor-grpc-port $INNGEST_CONNECT_EXECUTOR_GRPC_PORT -u https://localhost:$PORT/api/v1/inngest" C-m
fi

# Return to server pane (left)
tmux select-pane -L
