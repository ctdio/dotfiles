#!/bin/bash

# Parse arguments
NGROK_DOMAIN=""
CLOUDFLARED=false
CADDY=false
while [[ $# -gt 0 ]]; do
  case $1 in
    --domain|--ngrok)
      NGROK_DOMAIN="$2"
      shift 2
      ;;
    --cloudflare)
      CLOUDFLARED=true
      shift
      ;;
    --caddy)
      CADDY=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: start-dev [--ngrok <domain>] [--cloudflare] [--caddy]"
      exit 1
      ;;
  esac
done

# Detect worktree and calculate port
CURRENT_DIR=$(pwd)
DIR_NAME=$(basename "$CURRENT_DIR")

# Convert worktree suffix to slot number
# Supports both numeric (wt1, wt2) and alpha (wta, wtb)
# a=1, b=2, ..., z=26
worktree_suffix_to_slot() {
  local suffix="$1"
  if [[ "$suffix" =~ ^[0-9]+$ ]]; then
    echo "$suffix"
  elif [[ "$suffix" =~ ^[a-z]$ ]]; then
    # Convert a-z to 1-26
    printf '%d' "$(($(printf '%d' "'$suffix") - 96))"
  else
    echo ""
  fi
}

# Determine slot based on directory name
# platform -> slot 0, platform-wt1 -> slot 1, platform-wta -> slot 1, etc.
if [[ "$DIR_NAME" == "platform" ]]; then
  SLOT=0
elif [[ "$DIR_NAME" =~ ^platform-wt([0-9]+)$ ]]; then
  SLOT=${BASH_REMATCH[1]}
elif [[ "$DIR_NAME" =~ ^platform-wt([a-z])$ ]]; then
  SLOT=$(worktree_suffix_to_slot "${BASH_REMATCH[1]}")
else
  echo "Error: Must be run from platform or platform-wt* directory"
  echo "Current directory: $CURRENT_DIR"
  exit 1
fi

# Calculate ports based on slot (all ports end with slot number for clarity)
PORT=$((3000 + SLOT))
INNGEST_PORT=$((9000 + SLOT))
INNGEST_CONNECT_GATEWAY_PORT=$((8290 + SLOT))
INNGEST_CONNECT_GATEWAY_GRPC_PORT=$((50050 + SLOT))
INNGEST_CONNECT_EXECUTOR_GRPC_PORT=$((50060 + SLOT))

# Derive domain from worktree name
if [[ "$CLOUDFLARED" == "true" || "$CADDY" == "true" ]]; then
  if [[ "$DIR_NAME" =~ ^platform-wt([a-z])$ ]]; then
    CLOUDFLARED_DOMAIN="wt${BASH_REMATCH[1]}.ctdio.dev"
    CADDY_DOMAIN="wt${BASH_REMATCH[1]}.localhost"
  elif [[ "$DIR_NAME" == "platform" ]]; then
    echo "Error: --cloudflared/--caddy requires a worktree (platform-wt*), not the main platform directory"
    exit 1
  else
    echo "Error: Cannot derive domain from directory: $DIR_NAME"
    exit 1
  fi
fi

if [[ -n "$NGROK_DOMAIN" ]]; then
  echo "Starting opine-dev for $DIR_NAME with ngrok (domain: $NGROK_DOMAIN, inngest: $INNGEST_PORT)"
elif [[ "$CLOUDFLARED" == "true" ]]; then
  echo "Starting opine-dev for $DIR_NAME with cloudflared (domain: $CLOUDFLARED_DOMAIN, inngest: $INNGEST_PORT)"
elif [[ "$CADDY" == "true" ]]; then
  echo "Starting opine-dev for $DIR_NAME with caddy (domain: $CADDY_DOMAIN, inngest: $INNGEST_PORT)"
else
  echo "Starting opine-dev for $DIR_NAME (server: $PORT, inngest: $INNGEST_PORT)"
fi

# Kill all other panes, start fresh
tmux kill-pane -a

# Start server in current pane
if [[ -n "$NGROK_DOMAIN" ]]; then
  tmux send-keys "nx run platform:serve:ngrok --exclude-task-dependencies --domain $NGROK_DOMAIN" C-m
elif [[ "$CLOUDFLARED" == "true" ]]; then
  tmux send-keys "NEXT_PUBLIC_HOST=$CLOUDFLARED_DOMAIN NEXT_PUBLIC_SITE_URL=https://$CLOUDFLARED_DOMAIN nx run platform:serve:turbo --exclude-task-dependencies" C-m
elif [[ "$CADDY" == "true" ]]; then
  tmux send-keys "NEXT_PUBLIC_HOST=$CADDY_DOMAIN NEXT_PUBLIC_SITE_URL=https://$CADDY_DOMAIN nx run platform:serve:turbo --exclude-task-dependencies" C-m
else
  tmux send-keys "nx run platform:serve:turbo --exclude-task-dependencies" C-m
fi

# Create right pane (35%) for inngest
tmux split-window -h -l 35% -c "$CURRENT_DIR"
sleep 0.3  # Let shell initialize (fzf, etc.)

# Start inngest in right pane
if [[ $SLOT -eq 0 ]]; then
  # Root platform directory: use default inngest ports
  tmux send-keys "npx inngest-cli@latest dev --no-discovery --poll-interval 120 -u https://localhost:$PORT/api/v1/inngest" C-m
else
  # Worktree: use custom ports to avoid conflicts
  tmux send-keys "npx inngest-cli@latest dev --no-discovery --poll-interval 120 --port $INNGEST_PORT --connect-gateway-port $INNGEST_CONNECT_GATEWAY_PORT --connect-gateway-grpc-port $INNGEST_CONNECT_GATEWAY_GRPC_PORT --connect-executor-grpc-port $INNGEST_CONNECT_EXECUTOR_GRPC_PORT -u https://localhost:$PORT/api/v1/inngest" C-m
fi

# Return to server pane (left)
tmux select-pane -L
