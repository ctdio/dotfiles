#!/bin/bash

current_session_name="$(tmux display-message -p -F "#{session_name}")"
slot_letter="${1:-default}"
target_session_name="slot-${slot_letter}"
mode=$(tmux show-option -gqv @slot_mode)

if [[ "$mode" == "switch" ]]; then
    # Switch mode: switch to session full-screen (create if needed)
    if [[ "${current_session_name}" == "${target_session_name}" ]]; then
        # Already in target session, do nothing
        exit 0
    else
        tmux has-session -t "${target_session_name}" 2>/dev/null || tmux new-session -d -s "${target_session_name}"
        tmux switch-client -t "${target_session_name}"
        tmux set-option -g @last_slot "${slot_letter}"
    fi
elif [[ ${current_session_name} == slot-* ]]; then
    # Overlay mode: already in a slot
    if [[ "${current_session_name}" == "${target_session_name}" ]]; then
        # Same slot pressed - close overlay
        tmux detach-client
    else
        # Different slot - switch to it within overlay
        tmux has-session -t "${target_session_name}" 2>/dev/null || tmux new-session -d -s "${target_session_name}"
        tmux switch-client -t "${target_session_name}"
        tmux set-option -g @last_slot "${slot_letter}"
    fi
else
    # Overlay mode: open in overlay
    tmux set-option -g @last_slot "${slot_letter}"
    tmux popup \
      -w90% -h90% \
      -E "tmux attach -t ${target_session_name} || tmux new -s ${target_session_name}"
fi
