#!/bin/zsh
# Toggle between overlay and switch session modes

mode=$(tmux show-option -gqv @slot_mode)
current_session=$(tmux display-message -p -F "#{session_name}")

if [[ "$mode" == "switch" ]]; then
    tmux set-option -g @slot_mode overlay
    # If in a slot session (switch/full-screen), switch to non-slot and open as overlay
    if [[ "$current_session" == slot-* ]]; then
        # Find a non-slot session to switch to
        other_session=$(tmux list-sessions -F "#{session_name}" | grep -v "^slot-" | head -1)
        if [[ -n "$other_session" ]]; then
            tmux switch-client -t "$other_session"
            tmux popup -w90% -h90% -E "tmux attach -t ${current_session}"
        fi
    fi
else
    tmux set-option -g @slot_mode switch
    # If in a slot session (overlay), full-screen it
    if [[ "$current_session" == slot-* ]]; then
        # Find the outer client (not in a slot session) and switch it
        outer_client=$(tmux list-clients -F "#{client_name} #{session_name}" | grep -v "slot-" | head -1 | awk '{print $1}')
        if [[ -n "$outer_client" ]]; then
            tmux switch-client -c "$outer_client" -t "$current_session"
        fi
        tmux detach-client
    fi
fi
