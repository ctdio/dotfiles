#!/bin/bash

# Learnings loader — agent-agnostic, outputs scoped learnings to stdout.
# Usage: load-learnings [cwd]

LEARNINGS_DIR="$HOME/.ai/learnings"
TARGET_DIR="${1:-$PWD}"

# Detect project name from git remote, fall back to directory basename
detect_project() {
  local dir="$1"
  local remote
  remote=$(git -C "$dir" remote get-url origin 2>/dev/null)
  if [ -n "$remote" ]; then
    basename "$remote" .git
  else
    basename "$dir"
  fi
}

# Read content above the --- separator (or full file if no separator)
read_above_separator() {
  local file="$1"
  [ -f "$file" ] || return
  sed '/^---$/,$d' "$file"
}

# Read full file content
read_full() {
  local file="$1"
  [ -f "$file" ] || return
  cat "$file"
}

project=$(detect_project "$TARGET_DIR")
workspace=$(basename "$TARGET_DIR")

output=""

# Global learnings (above separator)
global_file="$LEARNINGS_DIR/global.md"
if [ -f "$global_file" ]; then
  content=$(read_above_separator "$global_file")
  if [ -n "$content" ]; then
    output+="# Global Learnings"$'\n\n'"$content"$'\n\n'
  fi
fi

# Project learnings (above separator)
project_file="$LEARNINGS_DIR/projects/$project/project.md"
if [ -f "$project_file" ]; then
  content=$(read_above_separator "$project_file")
  if [ -n "$content" ]; then
    output+="# Project Learnings ($project)"$'\n\n'"$content"$'\n\n'
  fi
fi

# Workspace learnings (full content)
workspace_file="$LEARNINGS_DIR/projects/$project/workspaces/$workspace.md"
if [ -f "$workspace_file" ]; then
  content=$(read_full "$workspace_file")
  if [ -n "$content" ]; then
    output+="# Workspace Learnings ($workspace)"$'\n\n'"$content"$'\n\n'
  fi
fi

# Output with instructions preamble if any learnings exist
if [ -n "$output" ]; then
  cat <<'PREAMBLE'
# Learnings — Persistent Knowledge Base

These learnings persist across sessions. Apply them to your work.

**These files are your working memory.** They survive across sessions so you and
future agents don't repeat discoveries, mistakes, or wasted effort. Treat them
like a developer's notebook — write to them as you work, not as an afterthought.

**Write a learning as soon as it happens:**
- You made a wrong assumption or took a bad approach → log what went wrong and the correct answer
- You discovered something useful (a pattern, shortcut, or how something works) → note it for next time
- You discovered a codebase pattern → note it so you don't have to rediscover it
- The user corrected you or stated a preference → record it before continuing
- You wasted time on something → log what you wish you'd known
- You found a useful command, flag, or config detail → jot it down

The cost of writing a one-line learning is near zero. The cost of rediscovering
something from scratch is high. Bias toward writing.

**How:** Add a bullet (`- <learning>`) under the right section header.
If the file doesn't exist, create it with section headers (Mistakes, Patterns, Preferences) + `---` separator.

**Where to write:**
- Global (`~/.ai/learnings/global.md`): Universal — any agent, any project
- Project (`~/.ai/learnings/projects/{repo}/project.md`): This codebase only
- Workspace (`~/.ai/learnings/projects/{repo}/workspaces/{workspace}.md`): This task only

PREAMBLE
  printf '%s' "$output"
fi
