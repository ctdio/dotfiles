#!/bin/bash

current_session_name="$(tmux display-message -p -F "#{session_name}")"
target_session_name="popup-${1:-default}"
mode=$(tmux show-option -gqv @session_popup_mode)

if [[ "$mode" == "direct" ]]; then
    # Direct mode: switch to session full-screen (create if needed)
    if [[ "${current_session_name}" == "${target_session_name}" ]]; then
        # Already in target session, do nothing
        exit 0
    else
        tmux has-session -t "${target_session_name}" 2>/dev/null || tmux new-session -d -s "${target_session_name}"
        tmux switch-client -t "${target_session_name}"
    fi
elif [[ ${current_session_name} == popup-* ]]; then
    # Popup mode: already in a popup, detach to close overlay
    tmux detach-client
else
    # Popup mode: open in overlay
    tmux popup \
      -w90% -h90% \
      -E "tmux attach -t ${target_session_name} || tmux new -s ${target_session_name}"
fi
