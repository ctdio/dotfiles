#!/bin/bash

# Ensure standard tmux sessions exist
# Usage: ensure-sessions [--attach]

# Build session directories dynamically
SESSION_DIRS=()

# Platform worktrees: a-z (only if directory exists)
for letter in {a..z}; do
  path="$HOME/projects/private/opine/platform-wt$letter"
  [[ -d "$path" ]] && SESSION_DIRS+=("$path")
done

# Other projects
SESSION_DIRS+=(
  "$HOME/dotfiles"
  "$HOME/projects/open-source/skim"
)

attach_first=false
if [[ "$1" == "--attach" ]]; then
  attach_first=true
fi

first_session=""

for path in "${SESSION_DIRS[@]}"; do
  name=$(basename "$path")

  # Skip if directory doesn't exist
  [[ ! -d "$path" ]] && continue

  if ! tmux has-session -t "$name" 2>/dev/null; then
    tmux new-session -d -s "$name" -c "$path"
    echo "Created session: $name"
  else
    echo "Session exists: $name"
  fi

  [[ -z "$first_session" ]] && first_session="$name"
done

# Optionally attach to first session
if $attach_first && [[ -n "$first_session" ]]; then
  if [[ -z "$TMUX" ]]; then
    tmux attach -t "$first_session"
  else
    tmux switch-client -t "$first_session"
  fi
fi
