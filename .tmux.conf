set-option -g focus-events on

set -g default-shell $SHELL
# set -g default-command "reattach-to-user-namespace -l ${SHELL}"

set -g default-terminal 'screen-256color'

set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q'
set -ga terminal-overrides ",xterm-kitty:Tc"

# Allow OSC 52 clipboard to pass through to the terminal (works over SSH)
set -s set-clipboard on

set -g window-size largest
set-window-option -g aggressive-resize on

# a little heavy handed maybe, stops right click menu from appearing
# when mouse moves out of tmux popup, which happens pretty often when
# switching spaces
unbind MouseDown3Pane

# open pane in same dir
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# set base index to 1 for easier window/pane switching
set -g base-index 1
setw -g pane-base-index 1

set-option -sg escape-time 0
set-option -g history-limit 5000

# use vim like syntax when navigating buffer
set-window-option -g mode-keys vi

# Session mode: overlay or switch (full screen)
set -g @slot_mode overlay

bind C-o run-shell '~/dotfiles/scripts/session-switch'
bind O display-popup -E "tms"
bind C-Space run-shell '~/dotfiles/scripts/agent-switch'
bind C-c command-prompt -p "Session name:" "new-session -s '%%'"
bind C-n switch-client -n
bind C-p switch-client -p
bind g run-shell '~/dotfiles/scripts/tmux-wt-switch >/dev/null 2>&1'
bind C-g run-shell '~/dotfiles/scripts/tmux-wt-jump >/dev/null 2>&1'
bind M run-shell '~/dotfiles/scripts/toggle-session-mode'
bind-key -T wt space switch-client -t platform
bind-key -T wt a switch-client -t platform-wta
bind-key -T wt b switch-client -t platform-wtb
bind-key -T wt c switch-client -t platform-wtc
bind-key -T wt d switch-client -t platform-wtd
bind-key -T wt e switch-client -t platform-wte
bind-key -T wt f switch-client -t platform-wtf
bind-key -T wt g switch-client -t platform-wtg
bind-key -T wt h switch-client -t platform-wth
bind-key -T wt i switch-client -t platform-wti
bind-key -T wt j switch-client -t platform-wtj
bind-key -T wt k switch-client -t platform-wtk
bind-key -T wt l switch-client -t platform-wtl
bind-key -T wt m switch-client -t platform-wtm
bind-key -T wt n switch-client -t platform-wtn
bind-key -T wt o switch-client -t platform-wto
bind-key -T wt p switch-client -t platform-wtp

bind C-h select-pane -L
bind C-j select-pane -D
bind C-k select-pane -U
bind C-l select-pane -R

# quick reload
bind R source-file '~/.tmux.conf'

bind-key C-h select-window -t 1
bind-key C-k select-window -t 2
bind-key C-e select-window -t 3
bind-key C-j select-window -t 4

# Mini vim popup - edit text, pastes into focused pane
bind C-v run-shell '~/dotfiles/scripts/tmux-vimput'

# Agent pane toggle (left side, 30% width max 80 cols)
bind C-y run-shell '~/dotfiles/scripts/agentpane'
# Toggle focus between agent pane and pane to its right
bind y run-shell '~/dotfiles/scripts/agent-focus'
# Agent queue picker - shows all tracked Claude Code agents across sessions
bind-key -T popup C-c send-keys -X cancel

bind-key h run-shell 'slotterm a'
bind-key k run-shell 'slotterm b'
bind-key e run-shell 'slotterm c'
bind-key j run-shell 'slotterm d'
# Worktree quick-switch: <prefix> t <letter> â†’ platform-wt<letter>
bind-key t switch-client -T wt

# enable visual selection with 'v' key
bind -T copy-mode-vi 'v' send -X begin-selection
# yank with 'y' (OS-aware: pbcopy on macOS, tmux's OSC 52 on Linux for SSH support)
if-shell 'uname | grep -q Darwin' \
  "bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'pbcopy'" \
  "bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel"

# slideout with C-b then b
bind b select-pane -t 0 \; resize-pane -Z

# even out panes
unbind =
bind = select-layout even-horizontal

# don't rename windows automatically
set-option -g allow-rename off

# status bar
set-option -g status-bg black
set-option -g status-fg white

set -g status-justify left
set -g status-interval 60

# Refresh status bar immediately on context changes
set-hook -g client-session-changed 'refresh-client -S'
set-hook -g after-select-pane 'refresh-client -S'
set-hook -g after-select-window 'refresh-client -S'

# Left: session name with branch, windows, and prefix indicator
set -g status-left-length 120
set -g status-left '#[fg=white]#{=/-20/...:session_name}#[fg=colour245]#(~/dotfiles/scripts/get-session-branch) #[fg=colour240]| #[default]#{W:#[fg=colour240]#I:#W ,#[fg=white]#I:#W }#{?client_prefix,#[fg=colour240]| #[fg=colour245][prefix],}#{?#{==:#{client_key_table},wt},#[fg=colour240]| #[fg=colour220][wt],}'

# Right: state indicators (copy, zoomed), mode, and time
# Mode hidden when in slot session + overlay mode (already obvious from overlay)
set -g status-right-length 60
set -g status-right '#{?pane_in_mode,#[fg=colour245][copy] ,}#{?window_zoomed_flag,#[fg=colour245][zoomed] ,}#{?#{&&:#{m:slot-*,#{session_name}},#{==:#{@slot_mode},overlay}},,#[fg=colour245]#{?#{==:#{@slot_mode},switch},--switch-- ,--overlay-- }}#[fg=white]%H:%M'

set -g pane-border-style fg=colour240
set -g pane-active-border-style fg=colour71

# Dim inactive panes
set -g window-style 'fg=colour244'
set -g window-active-style 'fg=white'

# Highlight active pane border
set -g pane-border-indicators arrows
set -g popup-border-style fg=colour243

setw -g monitor-activity off
set -g visual-activity off

# window status disabled - rendered in status-left via #{W}
set -g window-status-format ''
set -g window-status-current-format ''
set -g window-status-separator ' '

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'wfxr/tmux-fzf-url'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
